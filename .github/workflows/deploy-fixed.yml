name: ğŸš€ Auto Deploy IELTS Platform (Render + Vercel)

on:
  push:
    branches: ['main']

jobs:
  deploy:
    name: Deploy Backend & Frontend
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      NODE_ENV: production
      TZ: Asia/Ho_Chi_Minh

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§  Validate environment variables
        run: |
          echo "ğŸ” Checking secrets availability..."
          if [ -z "${{ secrets.RENDER_API_KEY }}" ]; then 
            echo "âš ï¸ Missing RENDER_API_KEY (Render will use webhook)"
          else
            echo "âœ… RENDER_API_KEY found"
          fi
          if [ -z "${{ secrets.RENDER_SERVICE_ID }}" ]; then 
            echo "âš ï¸ Missing RENDER_SERVICE_ID (Render will use webhook)"
          else
            echo "âœ… RENDER_SERVICE_ID found"
          fi
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then 
            echo "âš ï¸ Missing VERCEL_TOKEN (Vercel will use GitHub integration)"
          else
            echo "âœ… VERCEL_TOKEN found"
          fi

      - name: âš™ï¸ Deploy Backend to Render
        run: |
          echo "ğŸš€ Deploying backend (Render)..."
          if [ -n "${{ secrets.RENDER_API_KEY }}" ] && [ -n "${{ secrets.RENDER_SERVICE_ID }}" ]; then
            echo "ğŸ“¡ Triggering Render deployment via API v1..."
            HTTP_CODE=$(curl -s -o /tmp/render-response.json -w "%{http_code}" -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
              -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
              -H "Accept: application/json" \
              -H "Content-Type: application/json" \
              -d '{}' || echo "000")
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
              echo "âœ… Render deployment triggered successfully (HTTP $HTTP_CODE)"
              if [ -f /tmp/render-response.json ]; then
                echo "ğŸ“‹ Render API Response:"
                cat /tmp/render-response.json | head -20
              fi
            else
              echo "âš ï¸ Render API call returned: HTTP $HTTP_CODE (Render will auto-deploy via webhook)"
              if [ -f /tmp/render-response.json ]; then
                echo "ğŸ“‹ Error details:"
                cat /tmp/render-response.json | head -10
              fi
            fi
          else
            echo "â„¹ï¸ Render credentials missing â€” Render will auto-deploy via GitHub webhook."
          fi
        continue-on-error: true

      - name: ğŸ¨ Check Vercel Project Link
        working-directory: ./client
        run: |
          echo "ğŸ” Checking Vercel project configuration..."
          if [ -f ".vercel/project.json" ]; then
            echo "âœ… Found .vercel/project.json"
            cat .vercel/project.json | head -5
          else
            echo "âš ï¸ Missing .vercel/project.json. Run 'npx vercel link' manually to link project."
            echo "â„¹ï¸ Vercel will use GitHub integration for deployment instead."
          fi

      - name: ğŸ¨ Deploy Frontend to Vercel
        working-directory: ./client
        run: |
          echo "ğŸš€ Deploying frontend (Vercel)..."
          if [ -n "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "ğŸ“¡ Using Vercel CLI to deploy..."
            VERCEL_OUTPUT=$(npx vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes --force 2>&1) || VERCEL_EXIT=$?
            
            if [ "$VERCEL_EXIT" = "0" ] || [ -z "$VERCEL_EXIT" ]; then
              echo "âœ… Vercel deployment successful"
              echo "ğŸ“‹ Vercel CLI Response:"
              echo "$VERCEL_OUTPUT" | tail -20
            else
              echo "âš ï¸ Vercel CLI failed (exit code: $VERCEL_EXIT) â€” Vercel GitHub integration will handle deploy"
              echo "ğŸ“‹ Error output:"
              echo "$VERCEL_OUTPUT" | tail -20
            fi
          else
            echo "â„¹ï¸ No VERCEL_TOKEN found â€” Vercel GitHub integration will handle deploy."
          fi
        continue-on-error: true

      - name: ğŸ” Health Check (Render)
        run: |
          echo "ğŸ” Checking Render backend health..."
          sleep 10
          # Use the Render service URL (you may need to update this)
          RENDER_URL="https://ielts-platform-emrv.onrender.com"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$RENDER_URL/api/health" || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Backend is online (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ Backend health check returned: $HTTP_CODE (may still be deploying)"
          fi
        continue-on-error: true

      - name: ğŸ§¾ Save deployment logs
        run: |
          mkdir -p logs
          echo "[$(date -u +"%Y-%m-%d %H:%M:%S UTC")] Render deploy triggered" >> logs/deployments.log
          echo "[$(date -u +"%Y-%m-%d %H:%M:%S UTC")] Vercel deploy triggered" >> logs/deployments.log
          git config user.name "IELTS Platform Bot" || true
          git config user.email "ci@ieltsplatform.ai" || true
          git add logs/deployments.log || true
          git commit -m "ğŸª¶ Update deployment log [skip ci]" || echo "No changes to commit"
        continue-on-error: true

      - name: ğŸ§¯ Rollback Notification (if failed)
        if: failure()
        run: |
          echo "âš ï¸ Deployment step failed â€” please review logs and redeploy manually if needed"
          echo "ğŸ”— Render Dashboard: https://dashboard.render.com"
          echo "ğŸ”— Vercel Dashboard: https://vercel.com/dashboard"

      - name: âœ… Final Status
        run: |
          echo "ğŸ‰ All deployment steps executed successfully"
          echo "ğŸ“¦ Render: Check https://dashboard.render.com for deployment status"
          echo "ğŸ“¦ Vercel: Check https://vercel.com/dashboard for deployment status"
          echo "â„¹ï¸ Note: Both platforms also auto-deploy via GitHub webhooks/integration"

